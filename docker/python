FROM hearcch/webapp-server:latest

ARG PYTHON_VERSION
ARG UWSGI_PLUGIN_NAME

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update -q -y \
 && apt-get install -q -y \
        libcap-dev \
        libffi-dev \
        libpcre3-dev \
        libssl-dev \
        python${PYTHON_VERSION} \
        python${PYTHON_VERSION}-dev \
        python${PYTHON_VERSION}-venv \
        uuid-dev \
        uwsgi \
        uwsgi-src \
        uwsgi-plugin-python3 \
        uwsgi-plugin-asyncio-python3 \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/* /var/tmp/*

# Python
RUN curl https://bootstrap.pypa.io/get-pip.py | python${PYTHON_VERSION}

# uWSGI
# https://dev.to/pauloxnet/how-to-use-uwsgi-with-ptyhon36-in-ubuntu
RUN PYTHON=python${PYTHON_VERSION} uwsgi \
        --build-plugin "/usr/src/uwsgi/plugins/python python${UWSGI_PLUGIN_NAME}" \
 && mv python${UWSGI_PLUGIN_NAME}_plugin.so /usr/lib/uwsgi/plugins/python${UWSGI_PLUGIN_NAME}_plugin.so \
 && chmod 0644 /usr/lib/uwsgi/plugins/python${UWSGI_PLUGIN_NAME}_plugin.so

## Runit
COPY runit/uwsgi.sh /etc/service/uwsgi/run
RUN chmod +x /etc/service/uwsgi/run

# Templates
COPY files/python /var/templates/python
COPY scripts/Python.sh /usr/local/bin/Python.sh
RUN chmod o+x /usr/local/bin/Python.sh
# Develop
#COPY files/base /var/templates/base
#COPY scripts/boot.sh /usr/local/bin/boot.sh
#COPY scripts/setup.py /usr/local/bin/setup.py
#RUN chmod o+x /usr/local/bin/boot.sh \
# && chmod +x /usr/local/bin/setup.py


# Config
ENV CONFIG Python


ARG BUILD_DATE
ARG VCS_REF

LABEL org.label-schema.build-date=${BUILD_DATE} \
      org.label-schema.vcs-ref=${VCS_REF}

# vim: ft=dockerfile:
