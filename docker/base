FROM ubuntu:rolling

ARG MYSQL_VERSION
ARG NODEJS_VERSION
ARG POSTGRES_VERSION
ARG TINI_VERSION
ARG TINI_SIG

ARG DEBIAN_FRONTEND=noninteractive

ARG USERNAME=poweruser

# Ports
EXPOSE 22 80

# Config
ENV GROUPNAME unknown
ENV CONFIG Base


# Add Tini (reaping problem)
ADD https://github.com/krallin/tini/releases/download/v${TINI_VERSION}/tini /tini
RUN sig=`b2sum /tini | cut -d " " -f1` \
 && [ "$sig" = "${TINI_SIG}" ] \
 && chmod +x /tini \
 || exit 1

ENTRYPOINT ["/tini", "--"]

CMD [ "/usr/local/bin/boot.sh" ]

# All the packages.
RUN apt-get update -q \
 && apt-get upgrade -q -y \
 && apt-get install -q -y \
        acl \
        apt-transport-https \
        build-essential \
        ca-certificates \
        cron \
        curl \
        fontconfig \
        git \
        language-pack-de-base \
        language-pack-en-base \
        language-pack-fr-base \
        language-pack-it-base \
        libcurl4-gnutls-dev \
        libmysqlclient-dev \
        libpq-dev \
        libsass-dev \
        libsqlite3-dev \
        locales \
        lsof \
        man \
        mysql-client-${MYSQL_VERSION} \
        nano \
        nginx \
        openssh-server \
        postgresql-client-${POSTGRES_VERSION} \
        psmisc \
        python3-jinja2 \
        python3-pip \
        python3-venv \
        pwgen \
        runit \
        sqlite3 \
        software-properties-common \
        ssmtp \
        sudo \
        syslog-ng \
        unzip \
        vim \
        wget \
 && apt-get autoremove -y \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

# NodeSource Apt Repository
# https://deb.nodesource.com/setup_8.x
RUN echo "deb https://deb.nodesource.com/node_${NODEJS_VERSION} zesty main" \
  > /etc/apt/sources.list.d/nodesource.list
RUN wget --quiet -O - https://deb.nodesource.com/gpgkey/nodesource.gpg.key \
  | apt-key add -

# Installation of external and “experimental” packages
RUN apt-get update \
 && apt-get install -q -y \
    nodejs \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*


# Locale
RUN for l in "fr_CH" "de_CH" "it_CH" "en_US"; \
      do locale-gen $l \
      && locale-gen $l.UTF-8; \
    done \
 && update-locale LANG=fr_CH.UTF-8 LC_MESSAGES=POSIX


## Nginx
ARG f=/etc/nginx/nginx.conf
RUN rm /etc/nginx/sites-enabled/default \
 && rm -r /var/www/html \
    # auto worker processes and no daemonize (for runit)
 && sed -i 's/\(worker_processes\) .*;/\1 auto;\ndaemon off;/' $f \
    # logs to stdout
 && sed -i 's/\/var\/log\/nginx\/access.log/\/dev\/stdout/' $f \
 && sed -i 's/\/var\/log\/nginx\/error.log/\/dev\/stdout/' $f

# SSMTP
# mailhub configuration is done by setup.py
RUN sed -i 's/#FromLineOverride=YES/FromLineOverride=YES/' /etc/ssmtp/ssmtp.conf

# Cron
RUN sed -i 's/^\(SHELL=\)/MAILTO=""\n\1/' /etc/crontab

# OpenSSH Server
#
# * Disable password authentication
# * Disallow TCP forwarding
# * Delete any configured host keys (boot.sh)
#
ARG f=/etc/ssh/sshd_config
RUN mkdir /var/run/sshd \
 && sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication no/' $f \
 && sed -i 's/^AllowTcpForwarding yes/AllowTcpForwarding no/' $f \
 && rm -v /etc/ssh/ssh_host_*

# Syslog
#
# * Output all the things to stdout!
#
ARG f=/etc/syslog-ng/syslog-ng.conf
RUN sed -i 's/system()/#system()/' $f \
 && sed -i 's/^\(# The root\)/# Stdout\/Stderr\n\n\1/' $f \
 && sed -i 's/^\(# The root\)/destination d_stdout { pipe("\/dev\/stdout"); };\n\1/' $f \
 && sed -i 's/^\(# The root\)/destination d_stderr { pipe("\/dev\/stderr"); };\n\n\1/' $f \
 && sed -i 's/\(destination\)(d_[^)]*)/\1(d_stdout)/g' $f \
 && sed -i 's/\(filter(f_console);\)\s*destination(d_stdout);/\1/g' $f

#
# SUDO for any user
#
RUN echo '%users ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers.d/users
RUN chmod 0440 /etc/sudoers.d/users

# Templates
COPY files/base /var/templates/base

## Runit
COPY runit/cron.sh /etc/service/cron/run
COPY runit/nginx.sh /etc/service/nginx/run
COPY runit/sshd.sh /etc/service/sshd/run
COPY runit/syslog.sh /etc/service/syslog/run
COPY scripts/boot.sh /usr/local/bin/boot.sh
COPY scripts/setup.py /usr/local/bin/setup.py
RUN chmod +x /etc/service/cron/run \
 && chmod +x /etc/service/nginx/run \
 && chmod +x /etc/service/sshd/run \
 && chmod +x /etc/service/syslog/run \
 && chmod o+x /usr/local/bin/boot.sh \
 && chmod o+x /usr/local/bin/setup.py

# Logrotate
COPY files/base/vhost.logrotate /etc/logrotate.d/

# Expose VOLUME
VOLUME /root/config \
    /var/www

# Set correct environment variables.
ENV HOME /root

# This changes everytime so... the end is better.
ARG BUILD_DATE
ARG VCS_REF

LABEL maintainer="Yoan Blanc <yoan@dosimple.ch>" \
      org.label-schema.build-date=${BUILD_DATE} \
      org.label-schema.vendor="HE-Arc" \
      org.label-schema.vcs-ref=${VCS_REF} \
      org.label-schema.vcs-url="https://github.com/HE-Arc/webapp-server" \
      org.label-schema.schema-version="1.0"

# vim: ft=dockerfile:
